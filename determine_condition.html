<!DOCTYPE html>
<html>

<head>
    <title>Determine condition</title>
    <script src='jatos.js'></script>
    <script src='./jspsych-6.3.1/jspsych.js'></script>
    <script src='./extra_functions/lodash.js'></script>
    <script src='./extra_functions/trial_creator_triplets.js'></script>
    <script src='./extra_functions/triplet_creator.js'></script>
    <script src='./extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
    <script src='./extra_functions/combinations.js'></script>
    <link href='./jspsych-6.3.1/css/jspsych.css' rel='stylesheet' type='text/css'>
    </link>
    <link href='./extra_files/custom.css' rel='stylesheet' type='text/css'>
    </link>
</head>

<body></body>

<!-- <script type="module">
    debugger
    import * as $C from './extra_functions/combinatorics.js';
    window.Combinatorics = $C;
</script> -->

<script>

    jatos.onLoad(function () {
        // debugger

        // Define all the conditions here ///////////////////////////////////////////////////////////
        var timeline = []

        jatos.studySessionData.inputData.curr_session = 0

        // Component positions
        jatos.studySessionData.inputData.component_positions = {
            consent: 2,
            browser_check: 3,
            instructions: 5,
            triplet_task: 6,
            break: 7,
            debriefing: 8,
            data_submission: 9,
        }

        // All images
        jatos.studySessionData.inputData.all_exemplars = [
            './img/object-9_50-levels_1D/object9F0Level0F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level10F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level11F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level12F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level13F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level14F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level15F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level16F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level17F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level18F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level19F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level1F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level20F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level21F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level22F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level23F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level24F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level25F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level26F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level27F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level28F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level29F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level2F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level30F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level31F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level32F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level33F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level34F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level35F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level36F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level37F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level38F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level39F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level3F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level40F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level41F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level42F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level43F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level44F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level45F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level46F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level47F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level48F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level49F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level4F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level5F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level6F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level7F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level8F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level9F1Level14.png']


        // How many exposure sessions
        jatos.studySessionData.inputData.experiment_parameters = {
            n_exemplars: 10,
            exemplar_start_level: 14,
            n_practice_sessions: 1,
            n_triplet_sessions: 6,
            triplet_trial_dur: 5000,
            triplet_trial_iti: 500,
            triplet_stim_min_duration: 2000, // minimum milliseconds to display objectss
        }

        var [all_refs, all_queries] = triplet_creator(jatos.studySessionData.inputData.experiment_parameters.n_exemplars)

        // Now finally, create the actual trials 
        jatos.studySessionData.inputData.triplet_sessions = trial_creator_triplets(
            all_queries,
            all_refs,
            jatos.studySessionData.inputData.all_exemplars,
            jatos.studySessionData.inputData.experiment_parameters.n_triplet_sessions,
            jatos.studySessionData.inputData.experiment_parameters.exemplar_start_level
        )

        // Practice sessions
        jatos.studySessionData.inputData.practice_sessions[0] = jatos.studySessionData.inputData.triplet_sessions[2].slice(0, 5)

        jatos.studySessionData.inputData.session_counters = {
            practice: 0,
            triplet_task: 0,
        }

        if (jatos.componentJsonInput.debugMode) {
            // debugger

            jatos.studySessionData.inputData.experiment_parameters = {
                n_exemplars: 10,
                exemplar_start_level: 14,
                n_practice_sessions: 1,
                n_triplet_sessions: 2,
                triplet_trial_dur: 500,
                triplet_trial_iti: 10,
                triplet_stim_min_duration: 0, // minimum milliseconds to display objectss
            }

            let n_debug_trials = jatos.componentJsonInput.n_debug_trials
            
            // Remove extra sessions
            jatos.studySessionData.inputData.triplet_sessions.splice(jatos.studySessionData.inputData.experiment_parameters.n_triplet_sessions,
            jatos.studySessionData.inputData.triplet_sessions.length - jatos.studySessionData.inputData.experiment_parameters.n_triplet_sessions)

            // Shorten the trials
            let temp_practice = []
            jatos.studySessionData.inputData.practice_sessions.forEach(function (el) {
                temp_practice.push(el.slice(0, n_debug_trials))
            })
            jatos.studySessionData.inputData.practice_sessions = temp_practice

            let temp_triplet_task = []
            jatos.studySessionData.inputData.triplet_sessions.forEach(function (el) {
                temp_triplet_task.push(el.slice(0, n_debug_trials))
            })
            jatos.studySessionData.inputData.triplet_sessions = temp_triplet_task
        }

        // Make JATOS remember that this session was run
        jatos.studySessionData.latestFinishedComponentId = jatos.componentId;
        jatos.studySessionData.latestFinishedComponentPos = jatos.componentPos;
        jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

        jatos.submitResultData('done', function () { jatos.startComponentByPos(jatos.studySessionData.inputData.component_positions.instructions) })

        // jsPsych.init({

        // 	timeline: timeline,

        // 	on_finish: function(data) {




        //         // Make JATOS remember that this session was run
        //         jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
        //         jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
        //         jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

        //         jatos.submitResultData("[conditions_start---" + 
        //         JSON.stringify(jatos.studySessionData) + "---conditions_end]", function(){jatos.startComponentByPos(3)});

        // 	} // on finish
        // });     // jsPsych.init   

    }); // jatos on load

</script>

</html>