<!DOCTYPE html>
<html>

<head>
    <title>Determine condition</title>
    <script src='jatos.js'></script>
    <script src='./jspsych-6.3.1/jspsych.js'></script>
    <script src='./extra_functions/lodash.js'></script>
    <script src='./extra_functions/trial_creator_triplets.js'></script>
    <script src='./extra_functions/trial_creator_exposure.js'></script>
    <script src='./extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
    <script src='./extra_functions/combinations.js'></script>
    <link href='./jspsych-6.3.1/css/jspsych.css' rel='stylesheet' type='text/css'>
    </link>
    <link href='./extra_files/custom.css' rel='stylesheet' type='text/css'>
    </link>
</head>

<body></body>

<!-- <script type="module">
    debugger
    import * as $C from './extra_functions/combinatorics.js';
    window.Combinatorics = $C;
</script> -->

<script>

    jatos.onLoad(function () {
        // debugger

        // let c = new Combinatorics.Combination('abcdefgh', 4);

        // Define all the conditions here ///////////////////////////////////////////////////////////
        var timeline = []

        jatos.studySessionData.inputData.curr_session = 0

        // Component positions
        jatos.studySessionData.inputData.component_positions = {
            consent: 2,
            browser_check: 3,
            instructions: 5,
            triplet_task: 6,
            break: 7,
            debriefing: 8,
            data_submission: 9,
        }

        // All images
        jatos.studySessionData.inputData.all_exemplars = [
            './img/object-9_50-levels_1D/object9F0Level0F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level10F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level11F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level12F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level13F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level14F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level15F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level16F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level17F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level18F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level19F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level1F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level20F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level21F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level22F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level23F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level24F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level25F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level26F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level27F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level28F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level29F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level2F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level30F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level31F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level32F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level33F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level34F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level35F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level36F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level37F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level38F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level39F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level3F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level40F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level41F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level42F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level43F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level44F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level45F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level46F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level47F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level48F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level49F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level4F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level5F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level6F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level7F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level8F1Level14.png',
            './img/object-9_50-levels_1D/object9F0Level9F1Level14.png']

        // How many exemplars are we using
        var n_exemplars = 10

        // From which level do we start taking n_exemplars?
        var exemplar_start_level = 14


        // Generate holders for all the referents
        var all_refs = []
        var all_queries = []


        for (iT = 0; iT < n_exemplars; iT++) {

            // For each exemplar, generate all combinations of 2 from all the rest of exemplars
            let all_idxs = Array(n_exemplars).fill().map((element, index) => index)

            // Take all except iT
            all_idxs.splice(all_idxs.indexOf(iT), 1)

            // Create all possible permutations of n choose 2
            let refs = k_combinations(all_idxs, 2)

            // Create the array of the query items with the same length
            let queries = Array(refs.length).fill(iT)

            // Add these to the main variables
            all_refs.push(...refs)
            all_queries.push(...queries)

        }

        // Now, randomly, flip the referent orders
        let n_trials = all_refs.length
        let idx_sequences = Array(n_trials).fill().map((el, idx) => idx)

        let idx_to_flip = jsPsych.randomization.sampleWithoutReplacement(idx_sequences, n_trials / 2)

        for (iFlip = 0; iFlip < idx_to_flip.length; iFlip++) {

            let curr_idx = idx_to_flip[iFlip]

            all_refs[curr_idx] = all_refs[curr_idx].reverse()

        }

        // debugger
        // // Randomly shuffle both the query array and the ref array
        // let rand_idx = jsPsych.randomization.shuffle(idx_sequences)

        // all_queries = rand_idx.map(i => all_queries[i]);
        // all_refs    = rand_idx.map(i => all_refs[i]);

        // Now finally, create the actual trials 
        let n_sessions = 6
        jatos.studySessionData.inputData.all_sessions = trial_creator_triplets(
            all_queries,
            all_refs,
            jatos.studySessionData.inputData.all_exemplars,
            n_sessions,
            exemplar_start_level
        )


        debugger
        // How many exposure sessions
        jatos.studySessionData.inputData.experiment_parameters = {
            n_exposure_sessions: 7,
            n_practice_sessions: 1,
            n_pre_exp_triplet_sessions: 2,
            n_post_exp_triplet_sessions: 2,
            n_reps_per_triplet: 2,
            exposure_trial_dur: 3000,
            triplet_trial_dur: 5000,
            fixation_trial_dur: 500,
            triplet_trial_iti: 500,
            exposure_stim_min_duration: 2000, // minimum milliseconds to display birds
            triplet_stim_min_duration: 2000, // minimum milliseconds to display birds
        }

        jatos.studySessionData.inputData.session_counters = {
            practice: 0,
            triplet_task: 0,
        }

        // Practice trials 
        jatos.studySessionData.inputData.triplet_practice_trials = trial_creator_triplets(jatos.studySessionData.inputData.triplet_practice_params, jatos.studySessionData.inputData.experiment_parameters.n_reps_per_triplet,
            jatos.studySessionData.inputData.experiment_parameters.n_practice_sessions)

        // Create the pre-exposure trials
        jatos.studySessionData.inputData.pre_exposure_trials = trial_creator_triplets(jatos.studySessionData.inputData.pre_exposure_params, jatos.studySessionData.inputData.experiment_parameters.n_reps_per_triplet,
            jatos.studySessionData.inputData.experiment_parameters.n_pre_exp_triplet_sessions)

        if (jatos.componentJsonInput.debugMode) {
            // debugger
            jatos.studySessionData.inputData.experiment_parameters = {
                n_exposure_sessions: 2,
                n_practice_sessions: 1,
                n_pre_exp_triplet_sessions: 1,
                n_post_exp_triplet_sessions: 1,
                exposure_trial_dur: 2000,
                triplet_trial_dur: 10,
                fixation_trial_dur: 10,
                triplet_trial_iti: 10,
                triplet_stim_min_duration: 10,
                exposure_stim_min_duration: 2000, // minimum milliseconds to display birds
            }

            // debugger

            let n_debug_trials = 5

            let temp_exposure = []
            jatos.studySessionData.inputData.exposure_trials.forEach(function (el) {
                temp_exposure.push(el.slice(0, n_debug_trials))
            })
            jatos.studySessionData.inputData.exposure_trials = temp_exposure

            // Shorten the triplet trials
            let temp_practice = []
            jatos.studySessionData.inputData.triplet_practice_trials.forEach(function (el) {
                temp_practice.push(el.slice(0, n_debug_trials))
            })
            jatos.studySessionData.inputData.triplet_practice_trials = temp_practice


            let temp_pre_exp = []
            jatos.studySessionData.inputData.pre_exposure_trials.forEach(function (el) {
                temp_pre_exp.push(el.slice(0, n_debug_trials))
            })
            jatos.studySessionData.inputData.pre_exposure_trials = temp_pre_exp

            let temp_post_exp = []
            jatos.studySessionData.inputData.post_exposure_trials.forEach(function (el) {
                temp_post_exp.push(el.slice(0, n_debug_trials))
            })
            jatos.studySessionData.inputData.post_exposure_trials = temp_post_exp
        }


        // Make JATOS remember that this session was run
        jatos.studySessionData.latestFinishedComponentId = jatos.componentId;
        jatos.studySessionData.latestFinishedComponentPos = jatos.componentPos;
        jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

        jatos.submitResultData('done', function () { jatos.startComponentByPos(jatos.studySessionData.inputData.component_positions.instructions) })

        // jsPsych.init({

        // 	timeline: timeline,

        // 	on_finish: function(data) {




        //         // Make JATOS remember that this session was run
        //         jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
        //         jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
        //         jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

        //         jatos.submitResultData("[conditions_start---" + 
        //         JSON.stringify(jatos.studySessionData) + "---conditions_end]", function(){jatos.startComponentByPos(3)});

        // 	} // on finish
        // });     // jsPsych.init   

    }); // jatos on load

</script>

</html>